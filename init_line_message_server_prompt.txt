HÃ£y táº¡o má»™t server sá»­ dá»¥ng FastAPI, dÃ¹ng MySQL trong Docker lÃ m database, há»— trá»£ liÃªn káº¿t tÃ i khoáº£n ngÆ°á»i dÃ¹ng vá»›i LINE Messaging API vÃ  gá»­i tin nháº¯n cho ngÆ°á»i dÃ¹ng.

ğŸ¯ YÃªu cáº§u:
1. Login & Táº¡o liÃªn káº¿t:
GET /login: hiá»ƒn thá»‹ form nháº­p username giáº£ láº­p. Sau khi submit:

Sinh nonce, lÆ°u vÃ o DB vá»›i username

Redirect sang /link

GET /link: gá»i LINE API Ä‘á»ƒ táº¡o linkToken:
POST https://api.line.me/v2/bot/user/{userId}/linkToken
(Header: Authorization: Bearer {LINE_CHANNEL_ACCESS_TOKEN})

Táº¡o URL liÃªn káº¿t:
https://access.line.me/dialog/bot/accountLink?linkToken={linkToken}&nonce={nonce}
Gá»­i link nÃ y cho user.

2. Webhook tá»« LINE (POST /webhook):
XÃ¡c thá»±c chá»¯ kÃ½ webhook báº±ng LINE_CHANNEL_SECRET

Xá»­ lÃ½ 2 loáº¡i event:

âœ… a. accountLink (liÃªn káº¿t thÃ nh cÃ´ng):
json
Sao chÃ©p
Chá»‰nh sá»­a
{
  "type": "accountLink",
  "link": { "result": "ok", "nonce": "..." },
  "source": { "userId": "..." }
}
DÃ¹ng nonce Ä‘á»ƒ tÃ¬m user trong DB â†’ cáº­p nháº­t line_user_id

âœ… b. message (user gá»­i tin nháº¯n):
json
Sao chÃ©p
Chá»‰nh sá»­a
{
  "type": "message",
  "message": { "type": "text", "text": "..." },
  "source": { "userId": "..." }
}
Kiá»ƒm tra line_user_id cÃ³ tá»“n táº¡i trong báº£ng users:

Náº¿u Ä‘Ã£ liÃªn káº¿t â†’ tráº£ lá»i: "Báº¡n Ä‘Ã£ liÃªn káº¿t tÃ i khoáº£n thÃ nh cÃ´ng!"

Náº¿u chÆ°a liÃªn káº¿t:

Táº¡o linkToken

Gá»­i tin nháº¯n cÃ³ chá»©a link liÃªn káº¿t:
https://access.line.me/dialog/bot/accountLink?linkToken={linkToken}&nonce={nonce}

DÃ¹ng API Ä‘á»ƒ gá»­i tin nháº¯n:

css
Sao chÃ©p
Chá»‰nh sá»­a
POST https://api.line.me/v2/bot/message/push
Headers: Authorization: Bearer {LINE_CHANNEL_ACCESS_TOKEN}
Body:
{
  "to": "{userId}",
  "messages": [{ "type": "text", "text": "..." }]
}
3. Gá»­i tin nháº¯n tá»« há»‡ thá»‘ng (POST /send-message):
Nháº­n: { "user_id": 1, "message": "Hello" }

Truy line_user_id tá»« DB, gá»­i tin nháº¯n nhÆ° trÃªn.

4. API bá»• sung:
GET /users: tráº£ vá» danh sÃ¡ch user, tráº¡ng thÃ¡i liÃªn káº¿t LINE

ğŸ“¦ Há»‡ thá»‘ng:
FastAPI + SQLAlchemy

MySQL (Docker container, image mysql:8)

Dockerfile + docker-compose

.env-example chá»©a cÃ¡c biáº¿n mÃ´i trÆ°á»ng, dÃ¹ng .env Ä‘á»ƒ cháº¡y tháº­t

Sá»­ dá»¥ng venv, package lÆ°u trong requirements.txt

ğŸ” .env-example:
makefile
Sao chÃ©p
Chá»‰nh sá»­a
LINE_CHANNEL_SECRET=
LINE_CHANNEL_ACCESS_TOKEN=
BASE_URL=
DB_HOST=
DB_PORT=
DB_USER=
DB_PASSWORD=
DB_NAME=
ğŸ“„ README.md cáº§n hÆ°á»›ng dáº«n:
Táº¡o mÃ´i trÆ°á»ng áº£o (venv)

Cháº¡y Docker

Cáº¥u hÃ¬nh .env

DÃ¹ng ngrok test webhook LINE

Thá»±c hiá»‡n liÃªn káº¿t tÃ i khoáº£n

Gá»­i tin nháº¯n qua API